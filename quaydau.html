<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nhập Quay Đầu</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    background: #f8f9fa;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 40px 10px;
  }

  form {
    background: white;
    padding: 30px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgb(0 0 0 / 0.1);
    width: 700px;
  }

  h3 {
    text-align: center;
    margin-bottom: 25px;
  }

  a.btn-secondary {
    display: block;
    margin-bottom: 20px;
    width: 140px;
  }

  .money-input {
    max-width: 180px;
    text-align: right;
  }

  #denominations .input-group-text {
    min-width: 90px;
    text-align: right;
    font-weight: 600;
  }

  #denominations .denom-input {
    max-width: 100px;
    text-align: right;
  }

  /* 2 cột */
  .row-custom {
    display: flex;
    gap: 40px;
    flex-wrap: wrap;
  }

  .col-left, .col-right {
    flex: 1;
    min-width: 300px;
  }

  /* Các mục bên trái */
  .col-left .mb-3 {
    max-width: 100%;
  }

  #denominations {
    max-width: 100%;
  }

  /* Nút lưu full width */
  button[type="submit"] {
    width: 100%;
  }

  @media (max-width: 768px) {
    form {
      width: 100%;
      padding: 20px 15px;
    }
    .row-custom {
      flex-direction: column;
    }
  }
</style>
</head>
<body>

<form id="quayDauForm">
  <h3>Nhập thông tin Quay Đầu</h3>

  <a href="danhsach.html" class="btn btn-secondary">⬅ Xem danh sách</a>

  <div class="row-custom">
    <div class="col-left">
      <div class="mb-3">
        <label for="name" class="form-label">Tên</label>
        <select id="name" class="form-select" required>
          <option value="" disabled selected>Chọn tên hoặc nhập mới</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Chi tiết mệnh giá (số tờ)</label>
        <div id="denominations">
          <div class="input-group mb-2">
            <span class="input-group-text">500.000</span>
            <input type="number" min="0" value="0" class="form-control denom-input" data-value="500000" />
          </div>
          <div class="input-group mb-2">
            <span class="input-group-text">200.000</span>
            <input type="number" min="0" value="0" class="form-control denom-input" data-value="200000" />
          </div>
          <div class="input-group mb-2">
            <span class="input-group-text">100.000</span>
            <input type="number" min="0" value="0" class="form-control denom-input" data-value="100000" />
          </div>
          <div class="input-group mb-2">
            <span class="input-group-text">50.000</span>
            <input type="number" min="0" value="0" class="form-control denom-input" data-value="50000" />
          </div>
          <div class="input-group mb-2">
            <span class="input-group-text">20.000</span>
            <input type="number" min="0" value="0" class="form-control denom-input" data-value="20000" />
          </div>
          <div class="input-group mb-2">
            <span class="input-group-text">10.000</span>
            <input type="number" min="0" value="0" class="form-control denom-input" data-value="10000" />
          </div>
          <div class="input-group mb-2">
            <span class="input-group-text">5.000</span>
            <input type="number" min="0" value="0" class="form-control denom-input" data-value="5000" />
          </div>
        </div>
      </div>
    </div>

    <div class="col-right">
      <div class="mb-3">
        <label for="cash" class="form-label">Tiền mặt quay đầu</label>
        <input type="text" class="form-control money-input" id="cash" value="0" />
      </div>

      <div class="mb-3">
        <label for="bank" class="form-label">Chuyển khoản quay đầu</label>
        <input type="text" class="form-control money-input" id="bank" value="0" />
      </div>

      <div class="mb-3">
        <label for="mustPay" class="form-label">Tiền phải trả</label>
        <input type="text" class="form-control money-input" id="mustPay" value="0" />
      </div>
    </div>
  </div>

  <button type="submit" class="btn btn-primary mt-3">Lưu Quay Đầu</button>
</form>

<script>
  function loadNamesToSelect() {
    const select = document.getElementById("name");
    const data = JSON.parse(localStorage.getItem("paymentRecords") || "[]");
    const uniqueNames = [...new Set(data.map(record => record.name).filter(n => n.trim() !== ""))];
    uniqueNames.forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      select.appendChild(option);
    });
  }
  loadNamesToSelect();

  function formatNumberWithDots(x) {
    x = x.toString().replace(/[^\d]/g, "");
    if (x === "") return "";
    return x.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function parseNumberFromString(str) {
    return parseInt(str.replace(/\./g, '')) || 0;
  }

  function calculateCashFromCounts() {
    let total = 0;
    document.querySelectorAll('.denom-input').forEach(input => {
      const count = parseInt(input.value) || 0;
      const value = parseInt(input.dataset.value);
      total += count * value;
    });
    return total;
  }

  document.querySelectorAll('.money-input').forEach(input => {
    input.addEventListener('input', (e) => {
      if (e.target.id === "cash") {
        const cursorPosition = e.target.selectionStart;
        const oldLength = e.target.value.length;
        e.target.value = formatNumberWithDots(e.target.value);
        const newLength = e.target.value.length;
        const diff = newLength - oldLength;
        e.target.selectionEnd = cursorPosition + diff;
      } else {
        e.target.value = formatNumberWithDots(e.target.value);
      }
    });
  });

  document.querySelectorAll('.denom-input').forEach(input => {
    input.addEventListener('input', () => {
      const totalCash = calculateCashFromCounts();
      const cashInput = document.getElementById('cash');
      cashInput.value = formatNumberWithDots(totalCash.toString());
    });
  });

  const form = document.getElementById("quayDauForm");

  form.addEventListener("submit", e => {
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const cashStr = document.getElementById("cash").value;
    const bankStr = document.getElementById("bank").value;
    const mustPayStr = document.getElementById("mustPay").value;

    const cash = parseNumberFromString(cashStr);
    const bank = parseNumberFromString(bankStr);
    const mustPay = parseNumberFromString(mustPayStr);

    const time = new Date().toLocaleString("vi-VN");

    const counts = [];
    document.querySelectorAll('.denom-input').forEach(input => {
      const count = parseInt(input.value) || 0;
      const value = parseInt(input.dataset.value);
      counts.push({ denomination: value, count });
    });

    const diff = cash + bank - mustPay;

    const data = JSON.parse(localStorage.getItem("paymentRecords") || "[]");

    data.push({
      time,
      name,
      cash,
      bank,
      mustPay,
      diff,
      note: "(Quay đầu)",
      counts,
      type: "quay_dau"
    });

    localStorage.setItem("paymentRecords", JSON.stringify(data));

    alert("Lưu thành công!");
    form.reset();
    document.getElementById("name").selectedIndex = 0;
  });
</script>

</body>
</html>
